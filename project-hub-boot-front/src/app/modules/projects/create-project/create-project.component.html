<div class="card shadow-sm">
    <div class="card-body text-center">
        <div class="mb-4">
            <span class="d-block">
                Welcome to the project creation page. Here you can create a new project!
            </span>
            <span class="d-block mt-2">
                1. All Projects are based off information in the Repo. If something is missing, please add it to the repo then start making a new project.
            </span>
            <span class="d-block mt-2">
                2. First it will ask for the basic project information. 
            </span>
            <span class="d-block mt-2">
                3. Then it will have you confirm phase dates but these will be auto generated by default for each week. So be sure to verify those are right.
            </span>
            <span class="d-block mt-2">
                4. Then you can choose your team members and assign them to the project resource. 
            </span>
            <span class="d-block mt-2">
                5. Then you can choose your tasks, it will ask for task types, while the tasks with the type generic will be automatically added.
            </span>
            <span class="d-block mt-2">
                6. Then you can choose your notebooks, you want to add.
            </span>
            
            <div class="mt-4" *ngIf="!start">
                <button class="btn btn-primary" (click)="startProjectForm()">Start</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Information Form -->
<div class="card shadow-sm mt-4 fade-in" *ngIf="start">
    <div class="card-header">
        <h5 class="card-title mb-0">Project Information</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="projectName" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="projectName" [(ngModel)]="project.name" placeholder="Enter project name">
            </div>
            
            <div class="col-md-6">
                <label for="projectShortcode" class="form-label">Shortcode</label>
                <input type="text" class="form-control" id="projectShortcode" [(ngModel)]="project.shortcode" placeholder="Enter project shortcode">
            </div>
            
            <div class="col-12">
                <label for="projectDescription" class="form-label">Description</label>
                <textarea rows="5" class="form-control" id="projectDescription" [(ngModel)]="project.description" placeholder="Enter project description"></textarea>
            </div>
            
            <div class="col-md-6">
                <label for="projectStartDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="projectStartDate" [value]="formatDateForInput(project.startDate)" (change)="updateProjectStartDate($event)">
            </div>
            
            <div class="col-md-6">
                <label for="projectEndDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="projectEndDate" [value]="formatDateForInput(project.endDate)" (change)="updateProjectEndDate($event)">
            </div>
            
            <div class="col-md-6">
                <label for="projectStatus" class="form-label">Status</label>
                <select class="form-select" id="projectStatus" [(ngModel)]="project.status">
                    <option *ngFor="let statusOption of status" [value]="statusOption.value">{{ statusOption.label }}</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <label for="projectType" class="form-label">Type</label>
                <select class="form-select" id="projectType" [(ngModel)]="project.type">
                    <option *ngFor="let typeOption of type" [value]="typeOption.value">{{ typeOption.label }}</option>
                </select>
            </div>
        </div>
        
        <!-- Error message display -->
        <div class="alert alert-danger mt-3" *ngIf="projectFormInvalid">
            {{ projectFormErrorMessage }}
        </div>
        
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-secondary" (click)="resetForm()">Cancel</button>
            <button class="btn btn-primary" (click)="startNotebookForm()">Next: Notebooks</button>
        </div>
    </div>
</div>

<!-- Notebooks Selection -->
<div class="card shadow-sm mt-4 fade-in" *ngIf="startNotebook">
    <div class="card-header">
        <h5 class="card-title mb-0">Select Notebooks</h5>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <label class="form-label">Available Notebooks</label>
            <select multiple class="form-select" [(ngModel)]="selectedNotebooks" (ngModelChange)="onNotebookSelectionChange($event)" size="6">
                <option *ngFor="let notebook of notebookRepoService.allNotebooks()" [ngValue]="notebook">{{ notebook.name }}</option>
            </select>
        </div>
        
        <div class="text-center text-success my-3" *ngIf="selectedNotebooks.length > 0">
            {{ selectedNotebooks.length }} notebooks selected
        </div>
        
        <div class="text-center text-warning my-3" *ngIf="selectedNotebooks.length === 0">
            No notebooks selected. You can continue without notebooks or select some from the list.
        </div>
        
        <!-- Selected Notebooks Display -->
        <div class="mt-4" *ngIf="selectedNotebooks.length > 0">
            <h5 class="fw-semibold mb-3">Selected Notebooks</h5>
            <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                <div class="list-group-item" *ngFor="let notebook of selectedNotebooks; let i = index">
                    <div class="fw-semibold">{{ notebook.name }}</div>
                    <div class="small text-muted mt-1">{{ notebook.description }}</div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" (click)="start = true; startNotebook = false">Back</button>
            <button class="btn btn-primary" (click)="startResourceForm()">Next: Resources</button>
        </div>
    </div>
</div>

<!-- Resources Selection -->
<div class="card shadow-sm mt-4 fade-in" *ngIf="startResource">
    <div class="card-header">
        <h5 class="card-title mb-0">Select Resources</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label for="resource" class="form-label fw-semibold">Resource</label>
                <select id="resource" class="form-select" [(ngModel)]="selectedResourceId">
                    <option value="" disabled selected>Select a resource</option>
                    <option *ngFor="let resource of resourceRepoService.allResources()" [ngValue]="resource.id">{{ resource.name }}</option>
                </select>
                <div class="text-danger small mt-1" *ngIf="resourceRepoService.allResources().length === 0">
                    No resources available. Please check the resource repository.
                </div>
            </div>
            
            <div class="col-md-6">
                <label for="user" class="form-label fw-semibold">Assigned User</label>
                <select id="user" class="form-select" [(ngModel)]="selectedUserId">
                    <option value="" disabled selected>Select a user</option>
                    <option *ngFor="let user of userService.allUsers()" [ngValue]="user.id">{{ user.name }}</option>
                </select>
                <div class="text-danger small mt-1" *ngIf="userService.allUsers().length === 0">
                    No users available. Please check the user repository.
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-center mb-4">
            <button class="btn btn-primary" (click)="addResource()" [disabled]="!selectedResourceId || !selectedUserId">
                <i class="bi bi-plus-circle me-1"></i> Add Resource
            </button>
        </div>
        
        <!-- Debug button (can be removed in production) -->
        <div class="d-flex justify-content-center mb-2">
            <button class="btn btn-sm btn-outline-secondary" (click)="debugResourceSelection()">
                Debug Selection
            </button>
        </div>
        
        <hr>
        
        <!-- Selected Resources Table -->
        <div class="mt-4" *ngIf="project.projectResources && project.projectResources.length > 0">
            <h5 class="fw-semibold mb-3">Selected Resources</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Resource Name</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let resource of project.projectResources; let i = index">
                            <td>{{ resource.name }}</td>
                            <td>{{ resource.description }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" (click)="removeResource(i)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-center text-success">
                {{ project.projectResources.length }} resources selected
            </div>
        </div>
        
        <div class="text-center text-warning my-3" *ngIf="!project.projectResources || project.projectResources.length === 0">
            No resources assigned yet. Add resources by selecting a resource type and an assigned user.
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" (click)="startNotebook = true; startResource = false">Back</button>
            <button class="btn btn-primary" (click)="startPhaseForm()" [disabled]="submitting">
                <span class="spinner-border spinner-border-sm me-1" *ngIf="submitting"></span>
                Next: Phases
            </button>
        </div>
    </div>
</div>

<!-- Phases Selection -->
<div class="card shadow-sm mt-4 fade-in" *ngIf="startPhase">
    <div class="card-header">
        <h5 class="card-title mb-0">Select Phases</h5>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <label class="form-label">Available Phases</label>
            <select multiple class="form-select" [(ngModel)]="selectedPhases" (ngModelChange)="onPhaseSelectionChange($event)" size="6">
                <option *ngFor="let phase of phaseRepoService.allPhases()" [ngValue]="phase">{{ phase.name }}</option>
            </select>
        </div>
        
        <div class="text-center text-warning my-3" *ngIf="phases.length === 0">
            Please select at least one phase to continue.
        </div>
        
        <hr>
        
        <!-- Phase Configuration -->
        <div class="accordion mt-4" id="phasesAccordion" *ngIf="phases.length > 0">
            <div class="accordion-item" *ngFor="let phase of phases; let i = index">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#collapsePhase' + i">
                        Phase {{ phase.order }}: {{ phase.name }}
                    </button>
                </h2>
                <div [id]="'collapsePhase' + i" class="accordion-collapse collapse show" data-bs-parent="#phasesAccordion">
                    <div class="accordion-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Start Date</label>
                                <input type="date" class="form-control" [value]="formatDateForInput(phase.startDate)" (change)="updatePhaseStartDate(phase, $event)" required>
                                <small class="text-primary mt-1 d-block">{{ formatDate(phase.startDate) }}</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">End Date</label>
                                <input type="date" class="form-control" [value]="formatDateForInput(phase.endDate)" (change)="updatePhaseEndDate(phase, $event)" required>
                                <small class="text-primary mt-1 d-block">{{ formatDate(phase.endDate) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" (click)="startResource = true; startPhase = false">Back</button>
            <button class="btn btn-primary" (click)="startTaskForm()" [disabled]="phases.length === 0">Next: Tasks</button>
        </div>
    </div>
</div>

<!-- Task Selection -->
<div class="card shadow-sm mt-4 fade-in" *ngIf="startTask">
    <div class="card-header">
        <h5 class="card-title mb-0">Select Task Types</h5>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <label class="form-label">Task Types</label>
            <select multiple class="form-select" [(ngModel)]="selectedTaskTypes" (ngModelChange)="onTaskTypeSelectionChange($event)" size="6">
                <option *ngFor="let taskType of taskTypeRepoService.allTaskTypes()" [ngValue]="taskType">{{ taskType.name }}</option>
            </select>
        </div>
        
        <div class="text-center text-success my-3" *ngIf="selectedTaskTypes.length > 0">
            {{ totalTasksSelected }} tasks selected across {{ selectedTaskTypes.length }} types
        </div>
        
        <div class="text-center text-warning my-3" *ngIf="selectedTaskTypes.length === 0">
            No task types selected. Please select at least one task type to continue.
        </div>
        
        <!-- Tasks by Phase Display -->
        <div class="mt-4" *ngIf="selectedTaskTypes.length > 0">
            <h5 class="fw-semibold mb-3">Tasks by Phase</h5>
            <div class="card-group" style="max-height: 400px; overflow-y: auto;">
                <div class="card mb-3" *ngFor="let phase of project.projectPhases">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Phase {{ phase.order }}: {{ phase.name }}</h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">{{ phase.description }}</p>
                        
                        <div class="mt-3" *ngIf="phase.projectTasks.length > 0">
                            <h6 class="fw-semibold">Tasks ({{ phase.projectTasks.length }})</h6>
                            <ul class="list-group mt-2">
                                <li class="list-group-item border-start border-primary border-3" *ngFor="let task of phase.projectTasks">
                                    <div class="fw-medium">{{ task.name }}</div>
                                    <div class="small text-muted">{{ task.description }}</div>
                                    <div class="small text-muted mt-1">
                                        {{ formatDate(task.startDate) }} - {{ formatDate(task.endDate) }}
                                    </div>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="text-warning small mt-2" *ngIf="phase.projectTasks.length === 0">
                            No tasks assigned to this phase
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" (click)="startPhase = true; startTask = false">Back</button>
            <button class="btn btn-success" (click)="createProject()">Create Project</button>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="alert alert-success mt-3" *ngIf="submitSuccess">
    Project created successfully!
</div>

<div class="alert alert-danger mt-3" *ngIf="submitError">
    Error creating project: {{ errorMessage }}
</div>
